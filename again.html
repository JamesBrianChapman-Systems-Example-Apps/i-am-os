<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-AM-O.S. - Sovereign Operating System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            fill: #22d3ee;
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: rgba(51, 65, 85, 0.5);
        }

        .tab.active {
            background: #1e293b;
            color: #22d3ee;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-description {
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #0891b2;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0e7490;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
        }

        .btn-purple {
            background: #7c3aed;
            color: white;
        }

        .btn-purple:hover:not(:disabled) {
            background: #6d28d9;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #475569;
            color: #cbd5e1;
        }

        .btn-outline:hover {
            background: rgba(51, 65, 85, 0.5);
        }

        .info-box {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 0.95rem;
            color: #cbd5e1;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
            border: 1px solid #047857;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 1px solid #b91c1c;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            border: 1px solid #d97706;
        }

        .key-card,
        .exec-card,
        .memory-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .key-card:hover,
        .exec-card:hover,
        .memory-card:hover {
            border-color: #475569;
            background: rgba(15, 23, 42, 0.7);
        }

        .capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .capability-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid #6d28d9;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            color: #a78bfa;
        }

        .exec-io {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .code-block {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #cbd5e1;
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 0.375rem;
            color: #ffffff;
            font-size: 0.95rem;
            font-family: 'Courier New', monospace;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #cbd5e1;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            min-width: 250px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .memory-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #334155;
            flex-wrap: wrap;
        }

        .memory-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .memory-tab.active {
            color: #14b8a6;
            border-bottom-color: #14b8a6;
        }

        .search-box {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 0.375rem;
            color: #ffffff;
            font-size: 0.95rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .progress-indicator {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .progress-step.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .progress-step.active {
            background: rgba(34, 211, 238, 0.2);
            color: #22d3ee;
        }

        .progress-step.pending {
            background: rgba(71, 85, 105, 0.2);
            color: #64748b;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
            }

            .card-header {
                flex-direction: column;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                I-AM-O.S.
            </h1>
            <p>Sovereign Operating System ¬∑ Deterministic ¬∑ Browser-Native ¬∑ Fully Local</p>
        </div>

        <div class="progress-indicator" id="progress-indicator">
            <div style="margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.875rem;">Setup Progress</div>
            <div class="progress-steps">
                <div class="progress-step pending" data-step="identity">Identity</div>
                <div class="progress-step pending" data-step="genesis">Genesis</div>
                <div class="progress-step pending" data-step="policy">Policy Key</div>
                <div class="progress-step pending" data-step="execution">First Execution</div>
            </div>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-keys">0</div>
                <div class="stat-label">Policy Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-executions">0</div>
                <div class="stat-label">Executions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-memory">0</div>
                <div class="stat-label">Memory Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-uptime">-</div>
                <div class="stat-label">System Age</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="identity">üë§ Identity</button>
            <button class="tab" data-tab="genesis">üõ°Ô∏è Genesis</button>
            <button class="tab" data-tab="policy">üîë Policy Keys</button>
            <button class="tab" data-tab="execution">‚ö° Execution</button>
            <button class="tab" data-tab="memory">üíæ Memory</button>
            <button class="tab" data-tab="timeline">üìä Timeline</button>
            <button class="tab" data-tab="analytics">üìà Analytics</button>
            <button class="tab" data-tab="system">‚öôÔ∏è System</button>
        </div>

        <!-- Identity Panel -->
        <div id="identity-panel" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Identity Manager</div>
                        <div class="card-description">Root cryptographic identity using Ed25519 ‚Äì fully local</div>
                    </div>
                    <button class="btn btn-primary" onclick="generateIdentity()">+ Generate New DID</button>
                </div>
                <div id="identity-content"></div>
            </div>
        </div>

        <!-- Genesis Panel -->
        <div id="genesis-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Genesis Manager</div>
                        <div class="card-description">Immutable root of your sovereign instance</div>
                    </div>
                    <button class="btn btn-success" onclick="createGenesis()" id="genesis-btn">+ Create Genesis</button>
                </div>
                <div id="genesis-content"></div>
            </div>
        </div>

        <!-- Policy Keys Panel -->
        <div id="policy-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Policy-Bound Keys</div>
                        <div class="card-description">Capability-based cryptographic keys</div>
                    </div>
                    <button class="btn btn-purple" onclick="showCreateKeyModal()" id="create-key-btn">+ Create Key</button>
                </div>
                <div id="policy-content"></div>
            </div>
        </div>

        <!-- Execution Panel -->
        <div id="execution-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Deterministic Execution Plane (DCX)</div>
                        <div class="card-description">Append-only log of all executions</div>
                    </div>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="showExecuteModal()" id="execute-btn">‚ñ∂ Execute Unit</button>
                        <button class="btn btn-purple" onclick="showBatchExecuteModal()" id="batch-execute-btn">‚ö° Batch Execute</button>
                        <button class="btn btn-outline" onclick="showChainExecuteModal()" id="chain-execute-btn">üîó Chain Execute</button>
                    </div>
                </div>
                <div class="search-box" id="exec-search-box">
                    <input type="text" class="search-input" id="exec-search" placeholder="Search executions..." onkeyup="filterExecutions()">
                </div>
                <div id="execution-content"></div>
            </div>
        </div>

        <!-- Memory Panel -->
        <div id="memory-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Memory Store</div>
                        <div class="card-description">Immutable episodic, semantic, and procedural memory</div>
                    </div>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showMemoryModal()" id="memory-btn">+ Write Memory</button>
                    </div>
                </div>
                <div class="memory-tabs">
                    <button class="memory-tab active" data-filter="all">All (<span id="count-all">0</span>)</button>
                    <button class="memory-tab" data-filter="episodic">Episodic (<span id="count-episodic">0</span>)</button>
                    <button class="memory-tab" data-filter="semantic">Semantic (<span id="count-semantic">0</span>)</button>
                    <button class="memory-tab" data-filter="procedural">Procedural (<span id="count-procedural">0</span>)</button>
                </div>
                <div class="search-box" id="mem-search-box">
                    <input type="text" class="search-input" id="mem-search" placeholder="Search memory entries..." onkeyup="filterMemory()">
                </div>
                <div id="memory-content"></div>
            </div>
        </div>

        <!-- Timeline Panel -->
        <div id="timeline-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Activity Timeline</div>
                        <div class="card-description">Chronological view of all system events</div>
                    </div>
                    <button class="btn btn-outline" onclick="refreshTimeline()">üîÑ Refresh</button>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="timeline-search" placeholder="Filter timeline events..." onkeyup="filterTimeline()">
                </div>
                <div id="timeline-content"></div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div id="analytics-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">System Analytics</div>
                        <div class="card-description">Insights and metrics about your sovereign instance</div>
                    </div>
                </div>
                <div id="analytics-content"></div>
            </div>
        </div>

        <!-- System Panel -->
        <div id="system-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">System Controls</div>
                        <div class="card-description">Backup, restore, and manage your sovereign state</div>
                    </div>
                </div>
                <div class="info-row">
                    <div>
                        <button class="btn btn-success" onclick="exportState()">‚¨á Export Full State</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Download complete JSON backup</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportPartial()">‚¨á Export Partial</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Export specific sections</p>
                    </div>
                </div>
                <div class="info-row" style="margin-top:1.5rem">
                    <div>
                        <label class="btn btn-outline" style="cursor:pointer">
                            ‚¨Ü Import State
                            <input type="file" accept=".json" onchange="importState(this.files[0])" style="display:none" />
                        </label>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Restore from backup</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="verifyIntegrity()">üîç Verify Integrity</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Check data consistency</p>
                    </div>
                </div>
                <div class="info-row" style="margin-top:1.5rem">
                    <div>
                        <button class="btn btn-purple" onclick="signData()">‚úçÔ∏è Sign Data</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Cryptographically sign content</p>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="clearAllData()">üóë Clear All Data</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8">Permanently delete everything</p>
                    </div>
                </div>
                <div id="integrity-results" style="margin-top:2rem;display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Policy Key</div>
            </div>
            <div class="form-group">
                <label class="form-label">Capabilities *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label"><input type="checkbox" id="cap-inference"> inference</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-memory_read"> memory_read</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-memory_write"> memory_write</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-artifact_contribute"> artifact_contribute</label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Max Uses (optional)</label>
                <input type="number" class="form-input" id="key-maxuses" placeholder="Unlimited" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Delegation Depth</label>
                <input type="number" class="form-input" id="key-depth" value="3" min="0" max="10">
            </div>
            <button class="btn btn-purple" style="width:100%" onclick="createPolicyKey()">Create Key</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('create-key-modal')">Cancel</button>
        </div>
    </div>

    <div id="execute-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Execute Deterministic Unit</div>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-select" id="exec-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Query *</label>
                <textarea class="form-textarea" id="exec-input" placeholder="What is sovereignty?"></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="executeUnit()">‚ñ∂ Execute</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('execute-modal')">Cancel</button>
        </div>
    </div>

    <div id="batch-execute-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Batch Execute</div>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-select" id="batch-exec-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Queries (one per line) *</label>
                <textarea class="form-textarea" id="batch-exec-input" style="min-height:200px;"></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="executeBatch()">‚ö° Execute Batch</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('batch-execute-modal')">Cancel</button>
        </div>
    </div>

    <div id="chain-execute-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Chain Execute</div>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-select" id="chain-exec-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Initial Query *</label>
                <textarea class="form-textarea" id="chain-exec-initial"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Follow-up Template *</label>
                <textarea class="form-textarea" id="chain-exec-template">Based on {{output}}, explain...</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Chain Length</label>
                <input type="number" class="form-input" id="chain-exec-length" value="3" min="2" max="10">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="executeChain()">üîó Execute Chain</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('chain-execute-modal')">Cancel</button>
        </div>
    </div>

    <div id="memory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Write Memory Entry</div>
            </div>
            <div class="form-group">
                <label class="form-label">Memory Type *</label>
                <select class="form-select" id="mem-type">
                    <option value="episodic">Episodic</option>
                    <option value="semantic">Semantic</option>
                    <option value="procedural">Procedural</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-select" id="mem-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Content (JSON or text) *</label>
                <textarea class="form-textarea" id="mem-content"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Link to Existing Memory (optional)</label>
                <select class="form-select" id="mem-link">
                    <option value="">None</option>
                </select>
            </div>
            <button class="btn btn-success" style="width:100%" onclick="writeMemory()">+ Write Memory</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('memory-modal')">Cancel</button>
        </div>
    </div>

    <div id="partial-export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Partial Export</div>
            </div>
            <div class="form-group">
                <label class="form-label">Select Data to Export</label>
                <div class="checkbox-group">
                    <label class="checkbox-label"><input type="checkbox" id="export-identity" checked> Identity</label>
                    <label class="checkbox-label"><input type="checkbox" id="export-genesis" checked> Genesis</label>
                    <label class="checkbox-label"><input type="checkbox" id="export-keys" checked> Policy Keys</label>
                    <label class="checkbox-label"><input type="checkbox" id="export-executions" checked> Executions</label>
                    <label class="checkbox-label"><input type="checkbox" id="export-memory" checked> Memory</label>
                </div>
            </div>
            <button class="btn btn-success" style="width:100%" onclick="performPartialExport()">‚¨á Export Selected</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('partial-export-modal')">Cancel</button>
        </div>
    </div>

    <div id="sign-data-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Sign Data</div>
            </div>
            <div class="form-group">
                <label class="form-label">Data to Sign *</label>
                <textarea class="form-textarea" id="sign-data-input"></textarea>
            </div>
            <div class="form-group" id="signature-output" style="display:none;">
                <label class="form-label">Signature</label>
                <div class="code-block" id="signature-value"></div>
            </div>
            <button class="btn btn-purple" style="width:100%" onclick="performSignData()">‚úçÔ∏è Sign</button>
            <button class="btn btn-outline" style="width:100%;margin-top:0.5rem" onclick="copySignature()" id="copy-signature-btn" disabled>üìã Copy</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('sign-data-modal')">Close</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const DB_NAME = 'iamos-sovereign-v3';
        const DB_VERSION = 3;
        let db = null;
        let state = {
            identity: null,
            genesis: null,
            policyKeys: [],
            executions: [],
            memory: [],
            timeline: [],
            privateKey: null,
            currentMemoryFilter: 'all',
            searchQuery: ''
        };

        // Database
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    ['identity', 'genesis', 'policyKeys', 'executions', 'memory', 'keypairs'].forEach(store => {
                        if (!database.objectStoreNames.contains(store)) {
                            database.createObjectStore(store, {
                                keyPath: store === 'keypairs' ? 'id' : 'id'
                            });
                        }
                    });
                };
            });
        }

        async function dbGet(store, key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readonly');
                const req = tx.objectStore(store).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function dbGetAll(store) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readonly');
                const req = tx.objectStore(store).getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => reject(req.error);
            });
        }

        async function dbPut(store, value) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readwrite');
                const req = tx.objectStore(store).put(value);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function dbClear(store) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readwrite');
                const req = tx.objectStore(store).clear();
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        // Crypto
        async function generateDID() {
            const keyPair = await crypto.subtle.generateKey({
                name: 'Ed25519'
            }, true, ['sign', 'verify']);
            const publicRaw = await crypto.subtle.exportKey('raw', keyPair.publicKey);
            const publicHex = Array.from(new Uint8Array(publicRaw)).map(b => b.toString(16).padStart(2, '0')).join('');
            const privateJwk = await crypto.subtle.exportKey('jwk', keyPair.privateKey);
            const publicJwk = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
            await dbPut('keypairs', {
                id: 'primary',
                privateKey: privateJwk,
                publicKey: publicJwk
            });
            state.privateKey = keyPair.privateKey;
            return {
                id: `did:iamos:0x${publicHex.substring(0, 32)}`,
                publicKeyHex: publicHex,
                createdAt: Date.now()
            };
        }

        async function loadPrivateKey() {
            const kp = await dbGet('keypairs', 'primary');
            if (kp?.privateKey) {
                state.privateKey = await crypto.subtle.importKey('jwk', kp.privateKey, {
                    name: 'Ed25519'
                }, true, ['sign']);
            }
        }

        async function signMessage(message) {
            if (!state.privateKey) throw new Error('No private key');
            const data = new TextEncoder().encode(message);
            const sig = await crypto.subtle.sign({
                name: 'Ed25519'
            }, state.privateKey, data);
            return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateCID(obj) {
            const str = typeof obj === 'string' ? obj : JSON.stringify(obj);
            const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
            return `Qm${hex.substring(0, 44)}`;
        }

        function generateEntropy() {
            const arr = new Uint8Array(16);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateUniqueId(prefix = 'id') {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
        }

        // DCX Scheduler
        class DCXScheduler {
            validatePolicyKey(key) {
                if (!key || key.revoked) throw new Error('Invalid or revoked key');
                if (key.constraints.expiresAt && Date.now() > key.constraints.expiresAt) throw new Error('Key expired');
                if (!key.capabilities.includes('inference')) throw new Error('Missing inference capability');
                if (key.constraints.maxUses) {
                    const used = state.executions.filter(e => e.policyKeyId === key.keyId && e.status === 'completed').length;
                    if (used >= key.constraints.maxUses) throw new Error('Usage limit reached');
                }
            }

            async dispatch(unit, key, executor) {
                this.validatePolicyKey(key);
                unit.startedAt = Date.now();
                unit.status = 'pending';
                try {
                    unit.output = await executor(unit.input);
                    unit.status = 'completed';
                } catch (err) {
                    unit.status = 'failed';
                    unit.error = err.message;
                }
                unit.completedAt = Date.now();
                addToTimeline('execution', unit);
                return unit;
            }

            async dispatchBatch(units, key, executor) {
                const results = [];
                for (const unit of units) {
                    try {
                        results.push(await this.dispatch(unit, key, executor));
                    } catch (e) {
                        results.push({
                            ...unit,
                            status: 'failed',
                            error: e.message
                        });
                    }
                }
                return results;
            }

            async dispatchChain(initialUnit, key, executor, length, template) {
                const results = [];
                let currentInput = initialUnit.input;
                for (let i = 0; i < length; i++) {
                    const unit = {
                        id: generateUniqueId('exec'),
                        policyKeyId: key.keyId,
                        input: currentInput,
                        chainIndex: i,
                        parentId: i > 0 ? results[i - 1].id : null
                    };
                    const result = await this.dispatch(unit, key, executor);
                    results.push(result);
                    if (i < length - 1 && result.output) {
                        currentInput = {
                            payload: template.replace('{{output}}', result.output.result),
                            entropySeed: generateEntropy()
                        };
                    }
                }
                return results;
            }
        }
        const dcx = new DCXScheduler();

        // Inference (replace with real local LLM in production)
        async function sovereignInfer(input) {
            await new Promise(r => setTimeout(r, 300 + Math.random() * 300));
            const query = input.payload.toLowerCase();
            const map = {
                sovereignty: 'Sovereignty is absolute self-ownership of your computational substrate‚Äîno external control over data, identity, or execution.',
                deterministic: 'Deterministic execution guarantees identical outputs for identical inputs and seeds, enabling full reproducibility and auditability.',
                policy: 'Policy keys bind capabilities cryptographically, enforcing alignment through covenant rather than obedience.',
                genesis: 'The genesis block is the immutable root anchoring all subsequent state to your sovereign identity.',
                memory: 'Memory is content-addressed and immutable across episodic, semantic, and procedural layers.',
                identity: 'Your Ed25519-based DID establishes self-sovereign, cryptographically verifiable identity.'
            };
            for (const [k, v] of Object.entries(map)) {
                if (query.includes(k)) return {
                    result: v,
                    confidence: 0.9
                };
            }
            return {
                result: 'Local inference engine active. Replace mock with Ollama or WebLLM for production.',
                confidence: 0.7
            };
        }

        // Timeline
        function addToTimeline(type, data) {
            state.timeline.push({
                id: generateUniqueId('event'),
                type,
                timestamp: Date.now(),
                data
            });
            if (state.timeline.length > 1000) state.timeline = state.timeline.slice(-1000);
        }

        function refreshTimeline() {
            state.timeline = [];
            if (state.identity) addToTimeline('identity', {
                action: 'created',
                id: state.identity.id
            });
            if (state.genesis) addToTimeline('genesis', {
                action: 'created',
                cid: state.genesis.cid
            });
            state.policyKeys.forEach(k => addToTimeline('policy', {
                action: k.revoked ? 'revoked' : 'created',
                keyId: k.keyId
            }));
            state.executions.forEach(e => addToTimeline('execution', e));
            state.memory.forEach(m => addToTimeline('memory', m));
            renderTimeline();
            showToast('Timeline refreshed', 'success');
        }

        function renderTimeline() {
            const el = document.getElementById('timeline-content');
            if (state.timeline.length === 0) {
                el.innerHTML = '<div class="empty-state"><p>No events yet</p></div>';
                return;
            }
            let filtered = [...state.timeline].sort((a, b) => b.timestamp - a.timestamp);
            if (state.searchQuery) {
                filtered = filtered.filter(e => JSON.stringify(e).toLowerCase().includes(state.searchQuery));
            }
            const colors = {
                identity: '#22d3ee',
                genesis: '#10b981',
                policy: '#a78bfa',
                execution: '#3b82f6',
                memory: '#14b8a6'
            };
            el.innerHTML = filtered.map(ev => `
        <div class="key-card" style="border-left:3px solid ${colors[ev.type] || '#64748b'}">
          <div style="display:flex;justify-content:space-between;align-items:start;gap:1rem;">
            <div style="flex:1;">
              <div style="color:${colors[ev.type]};font-weight:600;margin-bottom:0.5rem;">${ev.type.toUpperCase()}</div>
              <div class="code-block" style="max-height:150px;">${JSON.stringify(ev.data, null, 2)}</div>
            </div>
            <div style="text-align:right;font-size:0.85rem;color:#94a3b8;">
              ${new Date(ev.timestamp).toLocaleString()}<br>${getRelativeTime(ev.timestamp)}
            </div>
          </div>
        </div>
      `).join('');
        }

        function filterTimeline() {
            state.searchQuery = document.getElementById('timeline-search').value.toLowerCase();
            renderTimeline();
        }

        // Analytics
        function renderAnalytics() {
            const el = document.getElementById('analytics-content');
            if (!state.identity) {
                el.innerHTML = '<div class="empty-state"><p>Create an identity to view analytics</p></div>';
                return;
            }
            const total = state.executions.length;
            const success = state.executions.filter(e => e.status === 'completed').length;
            const successRate = total ? (success / total * 100).toFixed(1) : 0;
            const avgTime = total ? (state.executions.reduce((s, e) => s + (e.completedAt - e.startedAt), 0) / total).toFixed(0) : 0;
            const activeKeys = state.policyKeys.filter(k => !k.revoked).length;
            const ageDays = Math.floor((Date.now() - state.identity.createdAt) / 86400000);
            const memByType = {
                episodic: state.memory.filter(m => m.type === 'episodic').length,
                semantic: state.memory.filter(m => m.type === 'semantic').length,
                procedural: state.memory.filter(m => m.type === 'procedural').length
            };
            el.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${successRate}%</div><div class="stat-label">Success Rate</div></div>
          <div class="stat-card"><div class="stat-value">${avgTime}ms</div><div class="stat-label">Avg Time</div></div>
          <div class="stat-card"><div class="stat-value">${activeKeys}/${state.policyKeys.length}</div><div class="stat-label">Active Keys</div></div>
          <div class="stat-card"><div class="stat-value">${ageDays}d</div><div class="stat-label">System Age</div></div>
        </div>
        <div class="card" style="margin-top:1.5rem;">
          <div class="card-title" style="margin-bottom:1rem;">Memory Distribution</div>
          <div class="info-row">
            <div><div class="info-label">Episodic</div><div class="info-value" style="color:#14b8a6;">${memByType.episodic}</div></div>
            <div><div class="info-label">Semantic</div><div class="info-value" style="color:#14b8a6;">${memByType.semantic}</div></div>
            <div><div class="info-label">Procedural</div><div class="info-value" style="color:#14b8a6;">${memByType.procedural}</div></div>
          </div>
        </div>
      `;
        }

        // UI Helpers
        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${id}"]`).classList.add('active');
            document.getElementById(`${id}-panel`).classList.add('active');
            if (id === 'timeline') refreshTimeline();
            if (id === 'analytics') renderAnalytics();
        }
        document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

        document.querySelectorAll('.memory-tab').forEach(t => t.addEventListener('click', () => {
            state.currentMemoryFilter = t.dataset.filter;
            document.querySelectorAll('.memory-tab').forEach(m => m.classList.remove('active'));
            t.classList.add('active');
            renderMemory();
        }));

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => {
            if (e.target === m) closeModal(m.id);
        }));

        function formatDate(ts) {
            return new Date(ts).toLocaleString();
        }

        function getRelativeTime(ts) {
            const d = Date.now() - ts;
            const s = Math.floor(d / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            const day = Math.floor(h / 24);
            if (day > 0) return `${day}d ago`;
            if (h > 0) return `${h}h ago`;
            if (m > 0) return `${m}m ago`;
            return `${s}s ago`;
        }

        function updateProgress() {
            const steps = {
                identity: !!state.identity,
                genesis: !!state.genesis,
                policy: state.policyKeys.length > 0,
                execution: state.executions.length > 0
            };
            let complete = true;
            for (const [k, v] of Object.entries(steps)) {
                const el = document.querySelector(`[data-step="${k}"]`);
                el.className = v ? 'progress-step completed' : 'progress-step pending';
                if (!v) complete = false;
            }
            document.getElementById('progress-indicator').style.display = complete ? 'none' : 'block';
        }

        function updateStats() {
            const grid = document.getElementById('stats-grid');
            if (!state.identity) {
                grid.style.display = 'none';
                return;
            }
            grid.style.display = 'grid';
            document.getElementById('stat-keys').textContent = state.policyKeys.length;
            document.getElementById('stat-executions').textContent = state.executions.length;
            document.getElementById('stat-memory').textContent = state.memory.length;
            const age = Date.now() - state.identity.createdAt;
            const days = Math.floor(age / 86400000);
            const hours = Math.floor((age % 86400000) / 3600000);
            document.getElementById('stat-uptime').textContent = days > 0 ? `${days}d ${hours}h` : `${hours}h`;
        }

        // Identity
        async function generateIdentity() {
            try {
                const did = await generateDID();
                state.identity = did;
                await dbPut('identity', {
                    ...did,
                    id: 'current'
                });
                addToTimeline('identity', {
                    action: 'created',
                    id: did.id
                });
                showToast('Identity generated', 'success');
                renderAll();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function renderIdentity() {
            const el = document.getElementById('identity-content');
            if (!state.identity) {
                el.innerHTML = '<div class="empty-state"><p>No identity ‚Äì generate one to begin</p></div>';
                return;
            }
            el.innerHTML = `
        <div class="info-box">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;">
            <div style="flex:1;"><div class="info-label">DID</div><div class="info-value">${state.identity.id}</div></div>
            <div class="badge badge-success">Active</div>
          </div>
          <div class="info-row">
            <div><div class="info-label">Public Key</div><div class="info-value">${state.identity.publicKeyHex.substring(0, 32)}...</div></div>
            <div><div class="info-label">Created</div><div class="info-value">${formatDate(state.identity.createdAt)}</div></div>
            <div><div class="info-label">Algorithm</div><div class="info-value">Ed25519</div></div>
          </div>
        </div>
      `;
        }

        // Genesis
        async function createGenesis() {
            if (!state.identity) return showToast('Create identity first', 'warning');
            const data = {
                protocolVersion: '1.0.0',
                founderDID: state.identity,
                createdAt: Date.now()
            };
            const cid = await generateCID(data);
            state.genesis = {
                cid,
                ...data
            };
            await dbPut('genesis', state.genesis);
            addToTimeline('genesis', {
                action: 'created',
                cid
            });
            showToast('Genesis established', 'success');
            renderAll();
        }

        function renderGenesis() {
            const el = document.getElementById('genesis-content');
            const btn = document.getElementById('genesis-btn');
            if (!state.identity) {
                el.innerHTML = '<div class="info-box"><strong style="color:#f59e0b;">‚ö† Identity required</strong></div>';
                btn.style.display = 'none';
                return;
            }
            if (!state.genesis) {
                el.innerHTML = '<div class="empty-state"><p>No genesis block</p></div>';
                btn.style.display = 'inline-flex';
                return;
            }
            btn.style.display = 'none';
            el.innerHTML = `
        <div class="info-box">
          <div style="margin-bottom:1rem;"><div class="info-label">CID</div><div class="info-value">${state.genesis.cid}</div></div>
          <div class="info-row">
            <div><div class="info-label">Version</div><div class="info-value">${state.genesis.protocolVersion}</div></div>
            <div><div class="info-label">Created</div><div class="info-value">${formatDate(state.genesis.createdAt)}</div></div>
            <div><div class="info-label">Founder DID</div><div class="info-value">${state.genesis.founderDID.id.substring(0, 24)}...</div></div>
          </div>
        </div>
      `;
        }

        // Policy Keys
        function showCreateKeyModal() {
            if (!state.identity) return showToast('Create identity first', 'warning');
            document.getElementById('create-key-modal').classList.add('active');
        }

        async function createPolicyKey() {
            const caps = ['inference', 'memory_read', 'memory_write', 'artifact_contribute']
                .filter(c => document.getElementById(`cap-${c}`).checked);
            if (caps.length === 0) return showToast('Select at least one capability', 'warning');
            const maxUses = document.getElementById('key-maxuses').value ? parseInt(document.getElementById('key-maxuses').value) : null;
            const depth = parseInt(document.getElementById('key-depth').value) || 3;
            const key = {
                keyId: generateUniqueId('pk'),
                owner: state.identity,
                capabilities: caps,
                constraints: {
                    maxUses,
                    delegationDepth: depth
                },
                revoked: false,
                createdAt: Date.now()
            };
            state.policyKeys.push(key);
            await dbPut('policyKeys', key);
            addToTimeline('policy', {
                action: 'created',
                keyId: key.keyId
            });
            closeModal('create-key-modal');
            showToast('Policy key created', 'success');
            renderAll();
        }

        async function revokeKey(id) {
            if (!confirm('Revoke this key?')) return;
            const key = state.policyKeys.find(k => k.keyId === id);
            if (key) {
                key.revoked = true;
                key.revokedAt = Date.now();
                await dbPut('policyKeys', key);
                addToTimeline('policy', {
                    action: 'revoked',
                    keyId: id
                });
                showToast('Key revoked', 'success');
                renderAll();
            }
        }

        function renderPolicy() {
            const el = document.getElementById('policy-content');
            if (!state.identity) {
                el.innerHTML = '<div class="empty-state"><p>Create identity first</p></div>';
                return;
            }
            if (state.policyKeys.length === 0) {
                el.innerHTML = '<div class="empty-state"><p>No policy keys</p></div>';
                return;
            }
            el.innerHTML = state.policyKeys.map(k => {
                const usage = state.executions.filter(e => e.policyKeyId === k.keyId).length;
                return `
          <div class="key-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
              <div style="flex:1;"><code style="color:#a78bfa;">${k.keyId}</code>
                <span class="badge ${k.revoked ? 'badge-danger' : 'badge-success'}">${k.revoked ? 'Revoked' : 'Active'}</span>
              </div>
              ${!k.revoked ? `<button class="btn btn-danger" onclick="revokeKey('${k.keyId}')">Revoke</button>` : ''}
            </div>
            <div class="capabilities">${k.capabilities.map(c => `<span class="capability-badge">${c}</span>`).join('')}</div>
            <div style="margin-top:1rem;color:#64748b;font-size:0.85rem;">
              Usage: ${usage}/${k.constraints.maxUses || '‚àû'} | Depth: ${k.constraints.delegationDepth}
            </div>
          </div>
        `;
            }).join('');
        }

        // Execution
        function showExecuteModal() {
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            if (keys.length === 0) return showToast('Create inference-capable key first', 'warning');
            updateExecuteModal();
            document.getElementById('execute-modal').classList.add('active');
        }

        function showBatchExecuteModal() {
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            if (keys.length === 0) return showToast('Create inference-capable key first', 'warning');
            const sel = document.getElementById('batch-exec-key');
            sel.innerHTML = '<option value="">Select key...</option>' + keys.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
            document.getElementById('batch-execute-modal').classList.add('active');
        }

        function showChainExecuteModal() {
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            if (keys.length === 0) return showToast('Create inference-capable key first', 'warning');
            const sel = document.getElementById('chain-exec-key');
            sel.innerHTML = '<option value="">Select key...</option>' + keys.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
            document.getElementById('chain-execute-modal').classList.add('active');
        }

        function updateExecuteModal() {
            const sel = document.getElementById('exec-key');
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            sel.innerHTML = '<option value="">Select key...</option>' + keys.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
        }

        async function executeUnit() {
            const keyId = document.getElementById('exec-key').value;
            const payload = document.getElementById('exec-input').value.trim();
            if (!keyId || !payload) return showToast('Key and query required', 'warning');
            const key = state.policyKeys.find(k => k.keyId === keyId);
            const unit = {
                id: generateUniqueId('exec'),
                policyKeyId: keyId,
                input: {
                    payload,
                    entropySeed: generateEntropy()
                }
            };
            const result = await dcx.dispatch(unit, key, sovereignInfer);
            state.executions.push(result);
            await dbPut('executions', result);
            closeModal('execute-modal');
            showToast('Execution completed', 'success');
            renderAll();
        }

        async function executeBatch() {
            const keyId = document.getElementById('batch-exec-key').value;
            const lines = document.getElementById('batch-exec-input').value.trim().split('\n').filter(l => l.trim());
            if (!keyId || lines.length === 0) return showToast('Key and queries required', 'warning');
            const key = state.policyKeys.find(k => k.keyId === keyId);
            const units = lines.map(p => ({
                id: generateUniqueId('exec'),
                policyKeyId: keyId,
                input: {
                    payload: p,
                    entropySeed: generateEntropy()
                }
            }));
            closeModal('batch-execute-modal');
            showToast(`Running ${lines.length} queries...`, 'success');
            const results = await dcx.dispatchBatch(units, key, sovereignInfer);
            for (const r of results) {
                state.executions.push(r);
                await dbPut('executions', r);
            }
            showToast(`${results.filter(r => r.status === 'completed').length}/${results.length} succeeded`, 'success');
            renderAll();
        }

        async function executeChain() {
            const keyId = document.getElementById('chain-exec-key').value;
            const initial = document.getElementById('chain-exec-initial').value.trim();
            const template = document.getElementById('chain-exec-template').value.trim();
            const length = parseInt(document.getElementById('chain-exec-length').value);
            if (!keyId || !initial || !template || length < 2) return showToast('All fields required', 'warning');
            const key = state.policyKeys.find(k => k.keyId === keyId);
            const initialUnit = {
                id: generateUniqueId('exec'),
                policyKeyId: keyId,
                input: {
                    payload: initial,
                    entropySeed: generateEntropy()
                }
            };
            closeModal('chain-execute-modal');
            showToast(`Running chain of ${length}...`, 'success');
            const results = await dcx.dispatchChain(initialUnit, key, sovereignInfer, length, template);
            for (const r of results) {
                state.executions.push(r);
                await dbPut('executions', r);
            }
            showToast('Chain completed', 'success');
            renderAll();
        }

        function renderExecution() {
            const el = document.getElementById('execution-content');
            const hasKey = state.policyKeys.some(k => !k.revoked && k.capabilities.includes('inference'));
            document.getElementById('execute-btn').style.display = hasKey ? 'inline-flex' : 'none';
            document.getElementById('batch-execute-btn').style.display = hasKey ? 'inline-flex' : 'none';
            document.getElementById('chain-execute-btn').style.display = hasKey ? 'inline-flex' : 'none';
            if (state.executions.length === 0) {
                el.innerHTML = '<div class="empty-state"><p>No executions yet</p></div>';
                document.getElementById('exec-search-box').style.display = 'none';
                return;
            }
            document.getElementById('exec-search-box').style.display = 'block';
            let list = [...state.executions].sort((a, b) => b.startedAt - a.startedAt);
            if (state.searchQuery) {
                list = list.filter(e => JSON.stringify(e).toLowerCase().includes(state.searchQuery));
            }
            el.innerHTML = list.map(u => `
        <div class="exec-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
            <div><code style="color:#3b82f6;">${u.id}</code>
              <span class="badge ${u.status === 'completed' ? 'badge-success' : 'badge-danger'}">${u.status}</span>
              ${u.chainIndex !== undefined ? `<span class="badge badge-warning">Chain ${u.chainIndex + 1}</span>` : ''}
            </div>
            <div style="font-size:0.85rem;color:#64748b;">
              ${u.completedAt - u.startedAt}ms ¬∑ ${getRelativeTime(u.startedAt)}
            </div>
          </div>
          <div class="exec-io">
            <div><div class="info-label">Input</div><div class="code-block">${u.input.payload}</div></div>
            <div><div class="info-label">Output</div><div class="code-block">${u.output?.result || u.error || '‚Äî'}</div></div>
          </div>
        </div>
      `).join('');
        }

        function filterExecutions() {
            state.searchQuery = document.getElementById('exec-search').value.toLowerCase();
            renderExecution();
        }

        // Memory
        function showMemoryModal() {
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('memory_write'));
            if (keys.length === 0) return showToast('Create memory_write key first', 'warning');
            const sel = document.getElementById('mem-key');
            sel.innerHTML = '<option value="">Select key...</option>' + keys.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
            const link = document.getElementById('mem-link');
            link.innerHTML = '<option value="">None</option>' + state.memory.map(m => `<option value="${m.cid}">${m.cid.substring(0, 16)}... (${m.type})</option>`).join('');
            document.getElementById('memory-modal').classList.add('active');
        }

        async function writeMemory() {
            const type = document.getElementById('mem-type').value;
            const keyId = document.getElementById('mem-key').value;
            const raw = document.getElementById('mem-content').value.trim();
            const link = document.getElementById('mem-link').value || null;
            if (!keyId || !raw) return showToast('Key and content required', 'warning');
            let content;
            try {
                content = JSON.parse(raw);
            } catch {
                content = {
                    text: raw
                };
            }
            const cid = await generateCID(content);
            const entry = {
                cid,
                type,
                content,
                policyKeyId: keyId,
                linkedTo: link,
                createdAt: Date.now()
            };
            state.memory.push(entry);
            await dbPut('memory', entry);
            addToTimeline('memory', entry);
            closeModal('memory-modal');
            showToast('Memory written', 'success');
            renderAll();
        }

        function renderMemory() {
            const el = document.getElementById('memory-content');
            const hasWrite = state.policyKeys.some(k => !k.revoked && k.capabilities.includes('memory_write'));
            document.getElementById('memory-btn').style.display = hasWrite ? 'inline-flex' : 'none';
            document.getElementById('count-all').textContent = state.memory.length;
            ['episodic', 'semantic', 'procedural'].forEach(t => {
                document.getElementById(`count-${t}`).textContent = state.memory.filter(m => m.type === t).length;
            });
            let list = state.currentMemoryFilter === 'all' ? state.memory : state.memory.filter(m => m.type === state.currentMemoryFilter);
            if (list.length === 0) {
                el.innerHTML = '<div class="empty-state"><p>No entries</p></div>';
                document.getElementById('mem-search-box').style.display = 'none';
                return;
            }
            document.getElementById('mem-search-box').style.display = 'block';
            if (state.searchQuery) {
                list = list.filter(m => JSON.stringify(m.content).toLowerCase().includes(state.searchQuery));
            }
            list = list.sort((a, b) => b.createdAt - a.createdAt);
            el.innerHTML = list.map(m => `
        <div class="memory-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
            <div><code style="color:#14b8a6;">${m.cid}</code>
              <span style="margin-left:0.5rem;padding:0.25rem 0.75rem;background:rgba(20,184,166,0.2);border:1px solid #14b8a6;border-radius:0.25rem;color:#14b8a6;font-size:0.85rem;">${m.type}</span>
              ${m.linkedTo ? '<span class="badge badge-warning">üîó Linked</span>' : ''}
            </div>
            <span style="font-size:0.85rem;color:#64748b;">${getRelativeTime(m.createdAt)}</span>
          </div>
          <div class="code-block">${JSON.stringify(m.content, null, 2)}</div>
        </div>
      `).join('');
        }

        function filterMemory() {
            state.searchQuery = document.getElementById('mem-search').value.toLowerCase();
            renderMemory();
        }

        // System
        async function exportState() {
            const data = {
                version: '1.0.0',
                exportedAt: Date.now(),
                identity: state.identity,
                genesis: state.genesis,
                policyKeys: state.policyKeys,
                executions: state.executions,
                memory: state.memory
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iamos-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Full state exported', 'success');
        }

        function exportPartial() {
            document.getElementById('partial-export-modal').classList.add('active');
        }

        async function performPartialExport() {
            const data = {
                version: '1.0.0',
                exportedAt: Date.now(),
                partial: true
            };
            if (document.getElementById('export-identity').checked) data.identity = state.identity;
            if (document.getElementById('export-genesis').checked) data.genesis = state.genesis;
            if (document.getElementById('export-keys').checked) data.policyKeys = state.policyKeys;
            if (document.getElementById('export-executions').checked) data.executions = state.executions;
            if (document.getElementById('export-memory').checked) data.memory = state.memory;
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iamos-partial-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            closeModal('partial-export-modal');
            showToast('Partial export completed', 'success');
        }

        async function importState(file) {
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (!data.identity) throw new Error('Invalid backup');
                if (!confirm('Import will overwrite all data. Continue?')) return;
                await dbClear('identity');
                await dbClear('genesis');
                await dbClear('policyKeys');
                await dbClear('executions');
                await dbClear('memory');
                await dbClear('keypairs');
                if (data.identity) await dbPut('identity', {
                    ...data.identity,
                    id: 'current'
                });
                if (data.genesis) await dbPut('genesis', data.genesis);
                for (const k of data.policyKeys || []) await dbPut('policyKeys', k);
                for (const e of data.executions || []) await dbPut('executions', e);
                for (const m of data.memory || []) await dbPut('memory', m);
                await loadAllFromDB();
                renderAll();
                showToast('State imported', 'success');
            } catch (e) {
                showToast('Import failed: ' + e.message, 'error');
            }
        }

        async function verifyIntegrity() {
            let html = '<div class="info-box"><div class="info-label" style="margin-bottom:1rem;">Integrity Results</div>';
            let valid = true;
            if (state.genesis) {
                const cid = await generateCID({
                    protocolVersion: state.genesis.protocolVersion,
                    founderDID: state.genesis.founderDID,
                    createdAt: state.genesis.createdAt
                });
                const ok = cid === state.genesis.cid;
                html += `<div>Genesis: <span class="badge ${ok ? 'badge-success' : 'badge-danger'}">${ok ? 'Valid' : 'Invalid'}</span></div>`;
                if (!ok) valid = false;
            }
            let memValid = 0,
                memInvalid = 0;
            for (const m of state.memory) {
                const cid = await generateCID(m.content);
                if (cid === m.cid) memValid++;
                else {
                    memInvalid++;
                    valid = false;
                }
            }
            html += `<div>Memory: ${memValid} valid, ${memInvalid} invalid</div>`;
            html += `<div style="margin-top:1rem;padding:1rem;background:rgba(${valid ? '16,185,129' : '239,68,68'},0.2);border-radius:0.5rem;">
        <strong style="color:${valid ? '#10b981' : '#ef4444'};">${valid ? 'All checks passed' : 'Issues detected'}</strong>
      </div></div>`;
            document.getElementById('integrity-results').innerHTML = html;
            document.getElementById('integrity-results').style.display = 'block';
            showToast(valid ? 'Integrity verified' : 'Integrity issues', valid ? 'success' : 'warning');
        }

        function signData() {
            if (!state.privateKey) return showToast('Generate identity first', 'warning');
            document.getElementById('sign-data-modal').classList.add('active');
        }

        async function performSignData() {
            const text = document.getElementById('sign-data-input').value.trim();
            if (!text) return showToast('Enter data to sign', 'warning');
            const sig = await signMessage(text);
            document.getElementById('signature-value').textContent = sig;
            document.getElementById('signature-output').style.display = 'block';
            document.getElementById('copy-signature-btn').disabled = false;
            showToast('Signed', 'success');
        }

        function copySignature() {
            navigator.clipboard.writeText(document.getElementById('signature-value').textContent);
            showToast('Copied', 'success');
        }

        async function clearAllData() {
            if (!confirm('Delete ALL data permanently?')) return;
            if (!confirm('Type YES to confirm final deletion.')) return;
            await dbClear('identity');
            await dbClear('genesis');
            await dbClear('policyKeys');
            await dbClear('executions');
            await dbClear('memory');
            await dbClear('keypairs');
            state = {
                identity: null,
                genesis: null,
                policyKeys: [],
                executions: [],
                memory: [],
                timeline: [],
                privateKey: null,
                currentMemoryFilter: 'all',
                searchQuery: ''
            };
            renderAll();
            showToast('All data cleared', 'success');
        }

        // State & Init
        async function loadAllFromDB() {
            state.identity = await dbGet('identity', 'current');
            state.genesis = (await dbGetAll('genesis'))[0] || null;
            state.policyKeys = await dbGetAll('policyKeys');
            state.executions = await dbGetAll('executions');
            state.memory = await dbGetAll('memory');
            await loadPrivateKey();
        }

        function renderAll() {
            renderIdentity();
            renderGenesis();
            renderPolicy();
            renderExecution();
            renderMemory();
            updateExecuteModal();
            updateProgress();
            updateStats();
        }

        (async () => {
            await initDB();
            await loadAllFromDB();
            renderAll();
        })();
    </script>
</body>

</html>